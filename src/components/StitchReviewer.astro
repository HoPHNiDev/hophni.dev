---
import { getCollection } from 'astro:content';

const stitchEntries = await getCollection('stitch');
const reviewsData = stitchEntries[0]?.data?.reviews ?? {};

const reviewsJson = JSON.stringify(reviewsData);
---

<!-- Stitch Code Reviewer tooltip — shows on tech badge hover -->
<div
  id="stitch-reviewer"
  class="fixed z-[60] pointer-events-none"
  style="display: none;"
>
  <div class="relative bg-[#1c2333] border border-primary/40 rounded-lg px-3 py-2 text-xs font-mono text-primary max-w-[240px] shadow-lg shadow-primary/10">
    <span id="stitch-reviewer-text"></span>
    <!-- Arrow pointing down, centered above badge -->
    <div id="stitch-reviewer-arrow" class="absolute -bottom-[6px] w-3 h-3 bg-[#1c2333] border-b border-r border-primary/40 rotate-45" style="left: 50%;"></div>
  </div>
</div>

<!-- Pass reviews data to inline script -->
<script id="stitch-reviews-data" type="application/json" set:html={reviewsJson}></script>

<script is:inline>
(function() {
  var dataEl = document.getElementById('stitch-reviews-data');
  var STITCH_REVIEWS = JSON.parse(dataEl.textContent);

  var tooltip = document.getElementById('stitch-reviewer');
  var textEl = document.getElementById('stitch-reviewer-text');
  var arrow = document.getElementById('stitch-reviewer-arrow');
  if (!tooltip || !textEl || !arrow) return;

  var hideTimeout = null;

  function showReview(badge, text) {
    if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
    textEl.textContent = text;

    // Make visible but off-screen to measure
    tooltip.style.left = '-9999px';
    tooltip.style.top = '-9999px';
    tooltip.style.display = 'block';
    tooltip.style.opacity = '0';

    var rect = badge.getBoundingClientRect();
    var tooltipRect = tooltip.getBoundingClientRect();
    var tooltipW = tooltipRect.width;
    var tooltipH = tooltipRect.height;

    // Center tooltip above badge
    var badgeCenterX = rect.left + rect.width / 2;
    var left = badgeCenterX - tooltipW / 2;

    // If overflows right → align tooltip's right edge near badge
    var margin = 8;
    if (left + tooltipW > window.innerWidth - margin) {
      left = window.innerWidth - tooltipW - margin;
    }
    // If overflows left
    if (left < margin) left = margin;

    // Arrow always points at badge center
    var arrowLeft = badgeCenterX - left;
    if (arrowLeft < 12) arrowLeft = 12;
    if (arrowLeft > tooltipW - 12) arrowLeft = tooltipW - 12;
    arrow.style.left = arrowLeft + 'px';

    var top = rect.top - tooltipH - 10;
    if (top < margin) top = rect.bottom + 10;

    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
    tooltip.style.opacity = '1';
  }

  function hideReview() {
    hideTimeout = setTimeout(function() {
      tooltip.style.opacity = '0';
      tooltip.style.display = 'none';
      hideTimeout = null;
    }, 150);
  }

  function hideImmediate() {
    if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
    tooltip.style.opacity = '0';
    tooltip.style.display = 'none';
  }

  window.addEventListener('scroll', hideImmediate, { passive: true });

  function attachListeners() {
    var badges = document.querySelectorAll('[data-tech], .tech-badge');
    badges.forEach(function(badge) {
      var tech = (badge.getAttribute('data-tech') || badge.textContent || '').trim().replace(/^"|"$/g, '').toLowerCase();
      var review = STITCH_REVIEWS[tech];
      if (!review) return;

      badge.style.cursor = 'pointer';
      badge.addEventListener('mouseenter', function() { showReview(badge, review); });
      badge.addEventListener('mouseleave', hideReview);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachListeners);
  } else {
    attachListeners();
  }
})();
</script>
