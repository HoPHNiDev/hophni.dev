---
import { getCollection } from 'astro:content';

const heroEntries = await getCollection('hero');
const heroData = heroEntries[0]?.data;
const username = heroData?.username ?? 'user';
const hostname = heroData?.hostname ?? 'portfolio';
const role = heroData?.role ?? 'Developer';
const bio = heroData?.bio ?? '';
const skills = heroData?.skills ?? {};

const contactEntries = await getCollection('contacts');
const contactData = contactEntries[0]?.data;
const contactLinks = contactData?.links ?? [];

const terminalEntries = await getCollection('terminal');
const terminalData = terminalEntries[0]?.data;
const commands = terminalData?.commands ?? {};
const sudoArt = terminalData?.sudoArt ?? '';
const neofetchInfo = terminalData?.neofetchInfo ?? {};

const commandsJson = JSON.stringify(commands);
const sudoArtJson = JSON.stringify(sudoArt);
const promptLabel = `${username}@${hostname}`;

// Build skills JSON string for cat skills.json
const skillsFormatted = JSON.stringify(
  Object.fromEntries(Object.entries(skills).map(([k, v]) => [k, v])),
  null, 2
);

// Build contact info for cat contact.sh
const contactFormatted = contactLinks.map(
  (l: { label: string; url: string }) => `  ${l.label}  â†’  ${l.url}`
).join('\n');
---

<div id="hidden-terminal" class="fixed inset-0 z-[100]" style="background: rgba(0,0,0,0.85); display: none;">
  <div id="terminal-window" class="w-full max-w-3xl mx-auto mt-4 terminal-slide" style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
    <!-- macOS-style terminal header -->
    <div id="terminal-header" class="bg-[#300a24] rounded-t-lg px-4 py-2.5 flex items-center gap-0 border-b border-[#5a2d4a]">
      <!-- Traffic lights -->
      <div class="flex items-center gap-[7px] group/dots">
        <button id="close-terminal" class="w-[13px] h-[13px] rounded-full bg-[#ec6a5f] flex items-center justify-center cursor-pointer border-0 p-0 transition-all" title="Close">
          <svg class="w-[9px] h-[9px] opacity-0 group-hover/dots:opacity-100 transition-opacity" viewBox="0 0 16 16"><path d="M4 4l8 8M12 4l-8 8" stroke="#b3462f" stroke-width="3" stroke-linecap="round"/></svg>
        </button>
        <button id="minimize-terminal" class="w-[13px] h-[13px] rounded-full bg-[#f5bf4f] flex items-center justify-center cursor-pointer border-0 p-0 transition-all" title="Minimize">
          <svg class="w-[9px] h-[9px] opacity-0 group-hover/dots:opacity-100 transition-opacity" viewBox="0 0 16 16"><path d="M3 8h10" stroke="#956d1b" stroke-width="3" stroke-linecap="round"/></svg>
        </button>
        <button id="fullscreen-terminal" class="w-[13px] h-[13px] rounded-full bg-[#62c554] flex items-center justify-center cursor-pointer border-0 p-0 transition-all" title="Full Screen">
          <svg id="fullscreen-icon" class="w-[8px] h-[8px] opacity-0 group-hover/dots:opacity-100 transition-opacity" viewBox="0 0 16 16">
            <path d="M3 3l4 0M3 3l0 4M13 13l-4 0M13 13l0-4" stroke="#2d8e30" stroke-width="3" stroke-linecap="round" fill="none"/>
          </svg>
        </button>
      </div>
      <span class="ml-4 text-sm text-[#d4bfcf] font-mono">{promptLabel}: ~</span>
    </div>
    <!-- Terminal body -->
    <div id="terminal-body" class="bg-[#300a24]/95 backdrop-blur-sm rounded-b-lg p-4 font-mono text-sm h-[60vh] overflow-y-auto text-[#d4bfcf] transition-all duration-300">
      <div id="terminal-output">
        <div class="text-accent-green">Welcome to {username} Terminal v2.0</div>
        <div class="text-gray-400">Type "help" for available commands. Press Tab for autocomplete.</div>
        <div class="mt-2"></div>
      </div>
      <div class="flex items-center gap-2" id="terminal-prompt-line">
        <span class="text-accent-green shrink-0">{promptLabel}</span><span class="text-white">:</span><span class="text-blue-400">~</span><span class="text-white">$</span>
        <input
          id="terminal-input"
          type="text"
          class="bg-transparent border-none outline-none text-white flex-1 font-mono text-sm"
          style="caret-color: #00FF00;"
          autocomplete="off"
          spellcheck="false"
        />
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes genie-out {
    0% { transform: perspective(600px) rotateX(0) translateY(0) scaleX(1) scaleY(1); opacity: 1; transform-origin: bottom right; }
    40% { transform: perspective(600px) rotateX(8deg) translateY(10vh) scaleX(0.7) scaleY(0.9); opacity: 0.8; transform-origin: bottom right; }
    100% { transform: perspective(600px) rotateX(20deg) translate(40vw, 90vh) scaleX(0.05) scaleY(0.02); opacity: 0; transform-origin: bottom right; }
  }
  .genie-minimize { animation: genie-out 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
</style>

<!-- Pass data to inline script -->
<script id="terminal-data" type="application/json" set:html={JSON.stringify({
  commands: commandsJson,
  sudoArt: sudoArtJson,
  prompt: promptLabel,
  role: role,
  bio: bio,
  skills: skillsFormatted,
  contactInfo: contactFormatted,
  neofetchInfo: JSON.stringify(neofetchInfo),
})}></script>

<script is:inline>
(function() {
  var dataEl = document.getElementById('terminal-data');
  var parsed = JSON.parse(dataEl.textContent);
  var COMMANDS = JSON.parse(parsed.commands);
  var STITCH_ASCII = JSON.parse(parsed.sudoArt);
  var PROMPT = parsed.prompt;
  var ROLE = parsed.role;
  var BIO = parsed.bio;
  var SKILLS_JSON = parsed.skills;
  var CONTACT_INFO = parsed.contactInfo;
  var NEOFETCH_INFO = JSON.parse(parsed.neofetchInfo);

  var terminal = document.getElementById('hidden-terminal');
  var input = document.getElementById('terminal-input');
  var output = document.getElementById('terminal-output');
  var closeBtn = document.getElementById('close-terminal');
  var tBody = document.getElementById('terminal-body');
  var terminalWindow = document.getElementById('terminal-window');

  // â”€â”€ All known commands for autocomplete â”€â”€
  var ALL_COMMANDS = [
    'help', 'whoami', 'cat skills.json', 'python3 info.py', 'cat contact.sh',
    'fetch_stack', 'neofetch', 'ls', 'pwd', 'date', 'uptime', 'history',
    'echo', 'clear', 'exit', 'sudo rm -rf /', 'cat .secret', 'cat about.py',
    'cd', 'cat README.md', 'cat .gitignore'
  ];

  // â”€â”€ Show / Hide / Toggle â”€â”€
  function showTerminal() {
    if (!terminal) return;
    var tw = document.getElementById('terminal-window');
    if (tw) tw.classList.remove('genie-minimize');
    terminal.style.display = '';
    if (input) input.focus();
  }

  function hideTerminal() {
    if (!terminal) return;
    terminal.style.display = 'none';
  }

  function toggleTerminal() {
    if (!terminal) return;
    if (terminal.style.display === 'none') {
      showTerminal();
    } else {
      hideTerminal();
    }
  }

  // â”€â”€ Keyboard shortcuts â”€â”€
  document.addEventListener('keydown', function(e) {
    var tag = e.target && e.target.tagName;
    var isTerminalInput = e.target && e.target.id === 'terminal-input';

    if ((e.key === '`' || e.key === '~') && !e.ctrlKey && !e.metaKey) {
      if (tag === 'INPUT' || tag === 'TEXTAREA') {
        if (isTerminalInput && terminal && terminal.style.display !== 'none') {
          e.preventDefault();
          hideTerminal();
        }
        return;
      }
      e.preventDefault();
      toggleTerminal();
      return;
    }

    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      toggleTerminal();
      return;
    }

    if (e.key === 'Escape' && terminal && terminal.style.display !== 'none') {
      hideTerminal();
    }
  });

  if (closeBtn) closeBtn.addEventListener('click', hideTerminal);

  // â”€â”€ Minimize â€” genie effect â”€â”€
  var minimizeBtn = document.getElementById('minimize-terminal');
  if (minimizeBtn) {
    minimizeBtn.addEventListener('click', function() {
      if (!terminalWindow) return;
      terminalWindow.classList.add('genie-minimize');
      setTimeout(hideTerminal, 500);
    });
  }

  // â”€â”€ Fullscreen toggle â”€â”€
  var fullscreenBtn = document.getElementById('fullscreen-terminal');
  var fullscreenIcon = document.getElementById('fullscreen-icon');
  var terminalHeader = document.getElementById('terminal-header');
  var isFullscreen = false;
  var expandPath = 'M3 3l4 0M3 3l0 4M13 13l-4 0M13 13l0-4';
  var collapsePath = 'M7 3l0 4M3 7l4 0M9 13l0-4M13 9l-4 0';

  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', function() {
      isFullscreen = !isFullscreen;
      if (isFullscreen) {
        if (terminalWindow) {
          terminalWindow.style.maxWidth = '100vw';
          terminalWindow.style.width = '100vw';
          terminalWindow.style.margin = '0';
          terminalWindow.style.marginTop = '0';
          terminalWindow.style.height = '100vh';
          terminalWindow.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          terminalWindow.style.flexDirection = 'column';
        }
        if (terminalHeader) terminalHeader.style.borderRadius = '0';
        if (tBody) {
          tBody.style.height = '';
          tBody.style.flex = '1';
          tBody.style.borderRadius = '0';
        }
        if (fullscreenIcon) fullscreenIcon.querySelector('path').setAttribute('d', collapsePath);
      } else {
        if (terminalWindow) {
          terminalWindow.style.maxWidth = '';
          terminalWindow.style.width = '';
          terminalWindow.style.margin = '';
          terminalWindow.style.marginTop = '';
          terminalWindow.style.height = '';
          terminalWindow.style.display = '';
          document.body.style.overflow = '';
          terminalWindow.style.flexDirection = '';
        }
        if (terminalHeader) terminalHeader.style.borderRadius = '';
        if (tBody) {
          tBody.style.height = '60vh';
          tBody.style.flex = '';
          tBody.style.borderRadius = '';
        }
        if (fullscreenIcon) fullscreenIcon.querySelector('path').setAttribute('d', expandPath);
      }
    });
  }

  // Click backdrop to close
  if (terminal) {
    terminal.addEventListener('click', function(e) {
      if (e.target === terminal) hideTerminal();
    });
  }

  // â”€â”€ Output helpers â”€â”€
  function addOutput(text, color) {
    if (!output) return;
    var div = document.createElement('div');
    div.className = (color || 'text-[#d4bfcf]') + ' whitespace-pre-wrap';
    div.textContent = text;
    output.appendChild(div);
    if (tBody) tBody.scrollTop = tBody.scrollHeight;
  }



  function addPrompt() {
    if (!output) return;
    var div = document.createElement('div');
    div.className = 'mt-2';
    output.appendChild(div);
  }

  // â”€â”€ Command history â”€â”€
  var cmdHistory = [];
  var historyIndex = -1;

  // â”€â”€ Tab Autocomplete â”€â”€
  function findMatch(partial) {
    if (!partial) return null;
    var lower = partial.toLowerCase();
    // Exact prefix match first
    var matches = ALL_COMMANDS.filter(function(cmd) {
      return cmd.toLowerCase().indexOf(lower) === 0;
    });
    if (matches.length === 1) return matches[0];
    if (matches.length > 1) return matches; // multiple matches
    return null;
  }

  // â”€â”€ Dynamic command handlers â”€â”€
  function handleCommand(val) {
    var lowerVal = val.toLowerCase().trim();

    // clear
    if (lowerVal === 'clear') {
      if (output) output.innerHTML = '';
      return;
    }

    // exit
    if (lowerVal === 'exit' || lowerVal === 'quit') {
      addOutput('logout', 'text-gray-400');
      setTimeout(hideTerminal, 300);
      return;
    }

    // sudo rm -rf /
    if (val === 'sudo rm -rf /') {
      document.body.classList.add('glitch-effect');
      setTimeout(function() { document.body.classList.remove('glitch-effect'); }, 300);
      addOutput(STITCH_ASCII, 'text-accent-green');
      addPrompt();
      return;
    }

    // cat skills.json â€” dynamic from hero data
    if (lowerVal === 'cat skills.json') {
      addOutput(SKILLS_JSON, 'text-syntax-string');
      addPrompt();
      return;
    }

    // python3 info.py â€” dynamic bio
    if (lowerVal === 'python3 info.py' || lowerVal === 'python info.py') {
      addOutput('"""', 'text-gray-400');
      addOutput(BIO, 'text-gray-400');
      addOutput('"""', 'text-gray-400');
      addPrompt();
      return;
    }

    // cat contact.sh â€” dynamic contacts
    if (lowerVal === 'cat contact.sh') {
      addOutput('#!/bin/bash', 'text-syntax-comment');
      addOutput('# Contact information\n', 'text-syntax-comment');
      addOutput(CONTACT_INFO);
      addPrompt();
      return;
    }

    // neofetch â€” system info with ASCII art (info from .md)
    if (lowerVal === 'neofetch') {
      var ascii = [
        '             .-/+oossssoo+/-.       ',
        '         `:+ssssssssssssssssss+:`   ',
        '       -+ssssssssssssssssssyyssss+- ',
        '     .ossssssssssssssssssdMMMNysssso.',
        '    /ssssssssssshdmmNNmmyNMMMMhssssss/',
        '   +ssssssssshmydMMMMMMMNddddyssssssss+',
        '  /sssssssshNMMMyhhyyyyhmNMMMNhssssssss/',
        ' .ssssssssdMMMNhsssssssssshNMMMdssssssss.',
        ' +sssshhhyNMMNyssssssssssssyNMMMysssssss+',
        ' ossyNMMMNyMMhsssssssssssssshmmmhssssssso',
        ' ossyNMMMNyMMhsssssssssssssshmmmhssssssso',
        ' +sssshhhyNMMNyssssssssssssyNMMMysssssss+',
        ' .ssssssssdMMMNhsssssssssshNMMMdssssssss.',
        '  /sssssssshNMMMyhhyyyyhdNMMMNhssssssss/',
        '   +sssssssssdmydMMMMMMMMddddyssssssss+',
        '    /ssssssssssshdmNNNNmyNMMMMhssssss/',
        '     .osssssssssssssssssssdMMMNysssso.',
        '       -+sssssssssssssssssyyyssss+-',
        '         `:+ssssssssssssssssss+:`',
        '             .-/+oossssoo+/-.'
      ];
      // Build info lines from editable neofetchInfo
      var infoKeys = Object.keys(NEOFETCH_INFO);
      var info = [PROMPT, 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'];
      for (var ik = 0; ik < infoKeys.length; ik++) {
        info.push(infoKeys[ik] + ': ' + NEOFETCH_INFO[infoKeys[ik]]);
      }
      while (info.length < ascii.length) info.push('');
      for (var ni = 0; ni < ascii.length; ni++) {
        var line = ascii[ni];
        while (line.length < 44) line += ' ';
        var infoLine = info[ni] || '';
        addOutput(line + infoLine, ni < 2 ? 'text-accent-green' : 'text-[#d4bfcf]');
      }
      addPrompt();
      return;
    }

    // cat about.py
    if (lowerVal === 'cat about.py') {
      addOutput('#!/usr/bin/env python3', 'text-syntax-comment');
      addOutput('', '');
      addOutput('class Developer:', 'text-syntax-keyword');
      addOutput('    name = "' + PROMPT.split('@')[0] + '"', 'text-syntax-string');
      addOutput('    role = "' + ROLE + '"', 'text-syntax-string');
      addOutput('    location = "Tashkent, Uzbekistan"', 'text-syntax-string');
      addOutput('    education = "Bachelor\'s, IT â€” Profi University (2024)"', 'text-syntax-string');
      addOutput('    languages = ["Russian ðŸ‡·ðŸ‡º", "English ðŸ‡¬ðŸ‡§", "Uzbek ðŸ‡ºðŸ‡¿"]', 'text-syntax-string');
      addPrompt();
      return;
    }

    // cat README.md
    if (lowerVal === 'cat readme.md') {
      addOutput('# ' + PROMPT.split('@')[0] + '\'s Portfolio', 'text-accent-green');
      addOutput('');
      addOutput('> ' + ROLE, 'text-syntax-string');
      addOutput('> ' + BIO.substring(0, 120) + '...', 'text-gray-400');
      addOutput('');
      addOutput('Built with Astro 5 + Tailwind CSS v4', 'text-primary');
      addOutput('Deployed on GitHub Pages', 'text-primary');
      addPrompt();
      return;
    }

    // echo
    if (lowerVal.indexOf('echo ') === 0) {
      var echoText = val.substring(5);
      addOutput(echoText);
      addPrompt();
      return;
    }

    // cd
    if (lowerVal === 'cd' || lowerVal.indexOf('cd ') === 0) {
      var target = val.substring(3).trim();
      if (!target || target === '~' || target === '.') {
        addOutput('/home/' + PROMPT.split('@')[0] + '/portfolio');
      } else if (target === 'projects' || target === 'projects/') {
        addOutput('Nice try. This is a single-page portfolio ðŸ˜', 'text-yellow-400');
      } else if (target === '..') {
        addOutput('Permission denied: you can\'t leave this portfolio ðŸ”’', 'text-red-400');
      } else {
        addOutput('cd: no such directory: ' + target, 'text-red-400');
      }
      addPrompt();
      return;
    }

    // date
    if (lowerVal === 'date') {
      addOutput(new Date().toString(), 'text-accent-green');
      addPrompt();
      return;
    }

    // history
    if (lowerVal === 'history') {
      if (cmdHistory.length === 0) {
        addOutput('  (no commands in history)', 'text-gray-400');
      } else {
        cmdHistory.forEach(function(cmd, i) {
          addOutput('  ' + (i + 1) + '  ' + cmd);
        });
      }
      addPrompt();
      return;
    }

    // rm
    if (lowerVal.indexOf('rm ') === 0) {
      addOutput('rm: permission denied. Stitch protects these files ðŸ›¡ï¸', 'text-red-400');
      addPrompt();
      return;
    }

    // mkdir / touch (with or without args)
    if (lowerVal === 'mkdir' || lowerVal.indexOf('mkdir ') === 0 || lowerVal === 'touch' || lowerVal.indexOf('touch ') === 0) {
      addOutput('Read-only filesystem. This portfolio is immutable âœ¨', 'text-yellow-400');
      addPrompt();
      return;
    }

    // vim / nano
    if (lowerVal.indexOf('vim ') === 0 || lowerVal === 'vim' || lowerVal.indexOf('nano ') === 0 || lowerVal === 'nano') {
      addOutput('Nice try! Use "cat" to read files instead ðŸ“–', 'text-yellow-400');
      addPrompt();
      return;
    }

    // git
    if (lowerVal === 'git status') {
      addOutput('On branch main', 'text-accent-green');
      addOutput('Your branch is up to date with \'origin/main\'.');
      addOutput('');
      addOutput('nothing to commit, working tree clean', 'text-accent-green');
      addPrompt();
      return;
    }
    if (lowerVal === 'git log' || lowerVal.indexOf('git log') === 0) {
      addOutput('commit a1b2c3d (HEAD -> main, origin/main)', 'text-yellow-400');
      addOutput('Author: hophni <hophnidev@gmail.com>');
      addOutput('Date:   ' + new Date().toDateString());
      addOutput('');
      addOutput('    update portfolio content âœ¨');
      addPrompt();
      return;
    }

    // pip
    if (lowerVal === 'pip list' || lowerVal === 'pip3 list') {
      addOutput('Package          Version', 'text-accent-green');
      addOutput('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€');
      addOutput('fastapi          0.115.0');
      addOutput('sqlalchemy       2.0.36');
      addOutput('pydantic         2.10.0');
      addOutput('celery           5.4.0');
      addOutput('pyrogram         2.0.106');
      addOutput('pytest           8.3.0');
      addPrompt();
      return;
    }

    // whoami â€” override with live data
    if (lowerVal === 'whoami') {
      addOutput(PROMPT.split('@')[0] + ' â€” ' + ROLE);
      addPrompt();
      return;
    }

    // Static commands from COMMANDS map
    if (COMMANDS[val]) {
      addOutput(COMMANDS[val]);
      addPrompt();
      return;
    }
    // Try lowercase match
    if (COMMANDS[lowerVal]) {
      addOutput(COMMANDS[lowerVal]);
      addPrompt();
      return;
    }

    // Unknown
    if (val) {
      addOutput('command not found: ' + val, 'text-red-400');
      addOutput('Type "help" for available commands.', 'text-gray-400');
    }
    addPrompt();
  }

  // â”€â”€ Input handler â”€â”€
  if (input) {
    input.addEventListener('keydown', function(e) {
      // Tab â€” autocomplete
      if (e.key === 'Tab') {
        e.preventDefault();
        var partial = input.value;
        if (!partial) return;
        var match = findMatch(partial);
        if (!match) return;
        if (typeof match === 'string') {
          // Single match â€” fill it in
          input.value = match;
        } else if (Array.isArray(match)) {
          // Multiple matches â€” show them
          addOutput(PROMPT + ':~$ ' + partial, 'text-accent-green');
          addOutput(match.join('  '), 'text-gray-400');
          addPrompt();
        }
        return;
      }

      // Arrow up â€” previous command
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (cmdHistory.length === 0) return;
        if (historyIndex < cmdHistory.length - 1) historyIndex++;
        input.value = cmdHistory[cmdHistory.length - 1 - historyIndex];
        return;
      }

      // Arrow down â€” next command
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
          historyIndex--;
          input.value = cmdHistory[cmdHistory.length - 1 - historyIndex];
        } else {
          historyIndex = -1;
          input.value = '';
        }
        return;
      }

      // Ctrl+L â€” clear
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        if (output) output.innerHTML = '';
        return;
      }

      // Enter â€” execute
      if (e.key !== 'Enter') return;
      var val = input.value.trim();
      input.value = '';
      historyIndex = -1;

      if (val) cmdHistory.push(val);

      addOutput(PROMPT + ':~$ ' + val, 'text-accent-green');
      handleCommand(val);
    });
  }
})();
</script>
